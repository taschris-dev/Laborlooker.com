// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String   @id @default(cuid())
  email                   String   @unique
  passwordHash            String   @map("password_hash")
  accountType             AccountType @map("account_type")
  emailVerified           Boolean  @default(false) @map("email_verified")
  approved                Boolean  @default(false)
  experienceLevel         String?  @map("experience_level")
  locationPreference      String?  @map("location_preference")
  starRatingPreference    Float?   @map("star_rating_preference")
  idVerificationStatus    String   @default("pending") @map("id_verification_status")
  idVerificationDocuments String?  @map("id_verification_documents")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Profile relationships
  professionalProfile ProfessionalProfile?
  customerProfile     CustomerProfile?
  networkingProfile   NetworkingProfile?
  jobSeekerProfile    JobSeekerProfile?

  // Work relationships
  customerRequests    WorkRequest[] @relation("CustomerRequests")
  contractorRequests  WorkRequest[] @relation("ContractorRequests")
  
  // Rating relationships
  ratingsGiven        UserRating[] @relation("RatingGiver")
  ratingsReceived     UserRating[] @relation("RatingReceiver")
  
  // Message relationships
  messagesSent        Message[] @relation("MessageSender")
  messagesReceived    Message[] @relation("MessageReceiver")
  
  // Authentication
  sessions            Session[]
  
  // Consent and privacy
  consentRecords      UserConsent[]
  dataActivities      UserDataCollection[]
  profileViewsMade    ProfileView[] @relation("ProfileViewer")
  profileViewsReceived ProfileView[] @relation("ProfileViewee")
  
  // Contract documents
  contractDocuments   ContractDocument[]
  
  // Two factor auth
  twoFactorAuth       TwoFactorAuth?

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  refreshToken String? @map("refresh_token")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model ProfessionalProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")
  businessName          String   @map("business_name")
  contactName           String   @map("contact_name")
  phone                 String?
  location              String?
  geographicArea        String?  @map("geographic_area")
  serviceRadius         Int?     @map("service_radius")
  billingPlan           String?  @map("billing_plan")
  commissionRate        Float?   @map("commission_rate")
  services              String?  // JSON string
  workHours             String?  @map("work_hours") // JSON string
  licenseVerified       Boolean  @default(false) @map("license_verified")
  insuranceVerified     Boolean  @default(false) @map("insurance_verified")
  businessDescription   String?  @map("business_description")
  yearsExperience       Int?     @map("years_experience")
  teamSize             Int?     @map("team_size")
  portfolioUrl         String?  @map("portfolio_url")
  minimumProjectSize   Float?   @map("minimum_project_size")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("professional_profiles")
}

model CustomerProfile {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  phone           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?  @map("zip_code")
  geographicArea  String?  @map("geographic_area")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("customer_profiles")
}

model NetworkingProfile {
  id                             String   @id @default(cuid())
  userId                         String   @unique @map("user_id")
  businessName                   String   @map("business_name")
  contactName                    String   @map("contact_name")
  phone                          String?
  location                       String?
  businessDescription            String?  @map("business_description")
  referralCode                   String   @unique @map("referral_code")
  totalNetworkEarnings           Float    @default(0.0) @map("total_network_earnings")
  platformCommissionCollected    Float    @default(0.0) @map("platform_commission_collected")
  verifiedLaborCategories        String?  @map("verified_labor_categories") // JSON string
  canPostJobs                    Boolean  @default(false) @map("can_post_jobs")
  createdAt                      DateTime @default(now()) @map("created_at")
  updatedAt                      DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("networking_profiles")
}

model JobSeekerProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")
  firstName             String?  @map("first_name")
  lastName              String?  @map("last_name")
  phone                 String?
  location              String?
  skillLevel            String?  @map("skill_level")
  desiredWagePerHour    Float?   @map("desired_wage_per_hour")
  availableStartDate    DateTime? @map("available_start_date")
  workingPreferences    String?  @map("working_preferences") // JSON string
  certifications        String?  // JSON string
  preferredIndustries   String?  @map("preferred_industries") // JSON string
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("job_seeker_profiles")
}

model WorkRequest {
  id               String            @id @default(cuid())
  customerId       String            @map("customer_id")
  contractorId     String?           @map("contractor_id")
  serviceCategories String           @map("service_categories") // JSON string
  geographicArea   String           @map("geographic_area")
  status           WorkRequestStatus @default(PENDING)
  description      String
  customerName     String           @map("customer_name")
  customerContact  String           @map("customer_contact")
  scheduledDate    DateTime?        @map("scheduled_date")
  completedDate    DateTime?        @map("completed_date")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  
  customer   User @relation("CustomerRequests", fields: [customerId], references: [id])
  contractor User? @relation("ContractorRequests", fields: [contractorId], references: [id])
  
  ratings    UserRating[]
  messages   Message[]
  contracts  ContractDocument[]
  
  @@map("work_requests")
}

model UserRating {
  id              String   @id @default(cuid())
  raterId         String   @map("rater_id")
  rateeId         String   @map("ratee_id")
  rating          Int
  comment         String?
  workRequestId   String?  @map("work_request_id")
  transactionType String   @map("transaction_type")
  createdAt       DateTime @default(now()) @map("created_at")
  
  rater       User        @relation("RatingGiver", fields: [raterId], references: [id])
  ratee       User        @relation("RatingReceiver", fields: [rateeId], references: [id])
  workRequest WorkRequest? @relation(fields: [workRequestId], references: [id])
  
  @@map("user_ratings")
}

model Message {
  id            String      @id @default(cuid())
  senderId      String      @map("sender_id")
  recipientId   String      @map("recipient_id")
  subject       String
  content       String
  messageType   MessageType @default(DIRECT) @map("message_type")
  priority      MessagePriority @default(NORMAL)
  status        MessageStatus @default(SENT)
  workRequestId String?     @map("work_request_id")
  sentAt        DateTime    @default(now()) @map("sent_at")
  deliveredAt   DateTime?   @map("delivered_at")
  readAt        DateTime?   @map("read_at")
  
  sender      User         @relation("MessageSender", fields: [senderId], references: [id])
  recipient   User         @relation("MessageReceiver", fields: [recipientId], references: [id])
  workRequest WorkRequest? @relation(fields: [workRequestId], references: [id])
  
  @@map("messages")
}

model UserConsent {
  id                  String   @id @default(cuid())
  userId              String?  @map("user_id")
  sessionId           String?  @map("session_id")
  ipAddress           String?  @map("ip_address")
  userAgent           String?  @map("user_agent")
  cookiesEssential    Boolean  @default(false) @map("cookies_essential")
  cookiesAnalytics    Boolean  @default(false) @map("cookies_analytics")
  cookiesMarketing    Boolean  @default(false) @map("cookies_marketing")
  termsOfService      Boolean  @default(false) @map("terms_of_service")
  privacyPolicy       Boolean  @default(false) @map("privacy_policy")
  dataCollection      Boolean  @default(false) @map("data_collection")
  dataResale          Boolean  @default(false) @map("data_resale")
  consentMethod       String?  @map("consent_method")
  consentVersion      String   @default("1.0") @map("consent_version")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  expiresAt           DateTime? @map("expires_at")
  
  user User? @relation(fields: [userId], references: [id])
  
  @@map("user_consents")
}

model UserDataCollection {
  id               String   @id @default(cuid())
  sessionId        String   @map("session_id")
  userId           String?  @map("user_id")
  ipAddress        String?  @map("ip_address")
  userAgent        String?  @map("user_agent")
  pageUrl          String?  @map("page_url")
  actionType       String?  @map("action_type")
  actionData       String?  @map("action_data") // JSON string
  country          String?
  state            String?
  city             String?
  consentGiven     Boolean  @default(false) @map("consent_given")
  consentTimestamp DateTime? @map("consent_timestamp")
  timestamp        DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id])
  
  @@map("user_data_collections")
}

model ProfileView {
  id             String   @id @default(cuid())
  viewerId       String   @map("viewer_id")
  viewedUserId   String   @map("viewed_user_id")
  viewType       String?  @map("view_type")
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  source         String?
  workRequestId  String?  @map("work_request_id")
  viewedAt       DateTime @default(now()) @map("viewed_at")
  
  viewer     User @relation("ProfileViewer", fields: [viewerId], references: [id])
  viewedUser User @relation("ProfileViewee", fields: [viewedUserId], references: [id])
  
  @@map("profile_views")
}

model ContractDocument {
  id                      String   @id @default(cuid())
  userId                  String   @map("user_id")
  envelopeId             String   @unique @map("envelope_id")
  documentType           String   @map("document_type")
  templateId             String?  @map("template_id")
  status                 String
  documentName           String   @map("document_name")
  sentAt                 DateTime @default(now()) @map("sent_at")
  deliveredAt            DateTime? @map("delivered_at")
  signedAt               DateTime? @map("signed_at")
  completedAt            DateTime? @map("completed_at")
  documentUrl            String?  @map("document_url")
  completedDocumentUrl   String?  @map("completed_document_url")
  workRequestId          String?  @map("work_request_id")
  contractValue          Float?   @map("contract_value")
  actionContext          String?  @map("action_context")
  templateData           String?  @map("template_data") // JSON string
  renewalRequired        Boolean  @default(false) @map("renewal_required")
  
  user        User         @relation(fields: [userId], references: [id])
  workRequest WorkRequest? @relation(fields: [workRequestId], references: [id])
  
  @@map("contract_documents")
}

model TwoFactorAuth {
  id          String   @id @default(cuid())
  userId      String   @unique @map("user_id")
  secret      String
  backupCodes String   @map("backup_codes") // JSON string
  enabled     Boolean  @default(false)
  lastUsed    DateTime? @map("last_used")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("two_factor_auth")
}

// File storage for uploaded media
model MediaFile {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  filename    String
  originalName String  @map("original_name")
  mimeType    String   @map("mime_type")
  size        Int
  key         String   @unique // S3/R2 key
  url         String   // CDN URL
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("media_files")
}

// Notification system
model Notification {
  id        String            @id @default(cuid())
  userId    String            @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      String?           // JSON string for additional data
  read      Boolean           @default(false)
  createdAt DateTime          @default(now()) @map("created_at")
  readAt    DateTime?         @map("read_at")
  
  @@map("notifications")
}

// Job queue for background processing
model Job {
  id          String    @id @default(cuid())
  type        String
  data        String    // JSON string
  status      JobStatus @default(PENDING)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")
  
  @@map("jobs")
}

// Enums
enum AccountType {
  CUSTOMER @map("customer")
  PROFESSIONAL @map("professional")
  JOB_SEEKER @map("job_seeker")
  NETWORKING @map("networking")
  
  @@map("account_type")
}

enum WorkRequestStatus {
  PENDING @map("pending")
  ASSIGNED @map("assigned")
  SCHEDULED @map("scheduled")
  COMPLETED @map("completed")
  CANCELLED @map("cancelled")
  
  @@map("work_request_status")
}

enum MessageType {
  DIRECT @map("direct")
  WORK_REQUEST @map("work_request")
  INVOICE @map("invoice")
  SYSTEM @map("system")
  
  @@map("message_type")
}

enum MessagePriority {
  LOW @map("low")
  NORMAL @map("normal")
  HIGH @map("high")
  URGENT @map("urgent")
  
  @@map("message_priority")
}

enum MessageStatus {
  SENT @map("sent")
  DELIVERED @map("delivered")
  READ @map("read")
  
  @@map("message_status")
}

enum NotificationType {
  WORK_REQUEST @map("work_request")
  MESSAGE @map("message")
  RATING @map("rating")
  SYSTEM @map("system")
  
  @@map("notification_type")
}

enum JobStatus {
  PENDING @map("pending")
  PROCESSING @map("processing")
  COMPLETED @map("completed")
  FAILED @map("failed")
  
  @@map("job_status")
}