version: 2

build:
  builder: NIXPACKS

deploy:
  restartPolicyType: ON_FAILURE
  restartPolicyMaxRetries: 10

services:
  api:
    source: apps/api
    variables:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${{Postgres.DATABASE_URL}}
      REDIS_URL: ${{Redis.REDIS_URL}}
      JWT_SECRET: ${{JWT_SECRET}}
      SMTP_HOST: ${{SMTP_HOST}}
      SMTP_PORT: ${{SMTP_PORT}}
      SMTP_USER: ${{SMTP_USER}}
      SMTP_PASS: ${{SMTP_PASS}}
      CLOUDFLARE_ACCOUNT_ID: ${{CLOUDFLARE_ACCOUNT_ID}}
      CLOUDFLARE_API_TOKEN: ${{CLOUDFLARE_API_TOKEN}}
      CLOUDFLARE_R2_BUCKET: ${{CLOUDFLARE_R2_BUCKET}}
    healthcheckPath: /health
    healthcheckTimeout: 300
    domains:
      - api.laborlookers.com

  web:
    source: apps/web
    variables:
      NODE_ENV: production
      PORT: 3001
      NEXT_PUBLIC_API_URL: https://api.laborlookers.com
      NEXT_PUBLIC_WS_URL: wss://ws.laborlookers.com
      NEXTAUTH_URL: https://app.laborlookers.com
      NEXTAUTH_SECRET: ${{NEXTAUTH_SECRET}}
    healthcheckPath: /health
    healthcheckTimeout: 300
    domains:
      - app.laborlookers.com

  ws:
    source: apps/ws
    variables:
      NODE_ENV: production
      PORT: 3002
      JWT_SECRET: ${{JWT_SECRET}}
    healthcheckPath: /health
    healthcheckTimeout: 300
    domains:
      - ws.laborlookers.com

  worker:
    source: apps/worker
    variables:
      NODE_ENV: production
      PORT: 3003
      DATABASE_URL: ${{Postgres.DATABASE_URL}}
      REDIS_URL: ${{Redis.REDIS_URL}}
      JWT_SECRET: ${{JWT_SECRET}}
      SMTP_HOST: ${{SMTP_HOST}}
      SMTP_PORT: ${{SMTP_PORT}}
      SMTP_USER: ${{SMTP_USER}}
      SMTP_PASS: ${{SMTP_PASS}}
    healthcheckPath: /health
    healthcheckTimeout: 300

plugins:
  - plugin: postgresql
    plan: hobby
  - plugin: redis
    plan: hobby