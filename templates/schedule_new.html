{% extends 'base.html' %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Schedule New Work/Appointment</h1>

<div class="bg-green-50 border border-green-200 rounded p-4 mb-6">
<h3 class="font-medium text-green-800 mb-2">Schedule Work & Track Jobs</h3>
<p class="text-green-700 text-sm">Schedule appointments, service calls, consultations, and track work completion with actual values.</p>
</div>

<form method="post" class="bg-white p-6 rounded shadow max-w-2xl space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Client/Business *</label>
<select name="client_id" required class="w-full border border-gray-300 rounded p-3" onchange="updateCustomerOptions()">
    <option value="">Select client business</option>
    {% for client in clients %}
    <option value="{{ client.id }}">{{ client.name }}</option>
    {% endfor %}
</select>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Prospect</label>
    <select name="prospect_id" class="w-full border border-gray-300 rounded p-3">
        <option value="">Select prospect (if applicable)</option>
        {% for prospect in prospects %}
        <option value="{{ prospect.id }}" data-client="{{ prospect.client_id }}">
            {{ prospect.name }} ({{ prospect.client.name }})
        </option>
        {% endfor %}
    </select>
    </div>
    
    <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Existing Customer</label>
    <select name="contact_id" class="w-full border border-gray-300 rounded p-3">
        <option value="">Select existing customer (if applicable)</option>
        {% for contact in contacts %}
        <option value="{{ contact.id }}" data-client="{{ contact.client_id }}">
            {{ contact.name }} ({{ contact.client.name }})
        </option>
        {% endfor %}
    </select>
    </div>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Work Title/Description *</label>
<input name="title" required class="w-full border border-gray-300 rounded p-3" 
       placeholder="HVAC System Installation, Plumbing Repair, etc." />
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Detailed Description</label>
<textarea name="description" rows="3" class="w-full border border-gray-300 rounded p-3" 
          placeholder="Specific work details, requirements, materials needed..."></textarea>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Scheduled Date & Time *</label>
    <input name="scheduled_date" type="datetime-local" required 
           class="w-full border border-gray-300 rounded p-3" />
    </div>
    
    <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Hours</label>
    <input name="estimated_hours" type="number" step="0.5" min="0" 
           class="w-full border border-gray-300 rounded p-3" placeholder="4.0" />
    </div>
    
    <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Value ($)</label>
    <input name="estimated_value" type="number" step="0.01" min="0" 
           class="w-full border border-gray-300 rounded p-3" placeholder="2500.00" />
    </div>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
<textarea name="notes" rows="2" class="w-full border border-gray-300 rounded p-3" 
          placeholder="Special instructions, access information, follow-up requirements..."></textarea>
</div>

<div class="flex gap-3">
<button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
    Schedule Work
</button>
<a href="/schedule" class="bg-gray-500 text-white px-6 py-3 rounded hover:bg-gray-600">
    Cancel
</a>
</div>
</form>

<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="bg-white rounded shadow p-4">
<h3 class="font-medium mb-3 text-blue-700">ðŸ’¡ Scheduling Tips</h3>
<ul class="text-sm text-gray-700 space-y-1">
<li>â€¢ Link to prospects for new customer work</li>
<li>â€¢ Link to existing customers for repeat work</li>
<li>â€¢ Set realistic time estimates</li>
<li>â€¢ Include material costs in value estimates</li>
</ul>
</div>

<div class="bg-white rounded shadow p-4">
<h3 class="font-medium mb-3 text-green-700">ðŸ“Š Work Types</h3>
<ul class="text-sm text-gray-700 space-y-1">
<li>â€¢ Service calls and repairs</li>
<li>â€¢ Installations and upgrades</li>
<li>â€¢ Consultations and quotes</li>
<li>â€¢ Maintenance visits</li>
</ul>
</div>
</div>

<script>
function updateCustomerOptions() {
    const clientSelect = document.querySelector('select[name="client_id"]');
    const prospectSelect = document.querySelector('select[name="prospect_id"]');
    const contactSelect = document.querySelector('select[name="contact_id"]');
    
    const selectedClientId = clientSelect.value;
    
    // Filter prospect options
    Array.from(prospectSelect.options).forEach(option => {
        if (option.value === '') return;
        const clientId = option.getAttribute('data-client');
        option.style.display = (clientId === selectedClientId) ? 'block' : 'none';
    });
    
    // Filter contact options
    Array.from(contactSelect.options).forEach(option => {
        if (option.value === '') return;
        const clientId = option.getAttribute('data-client');
        option.style.display = (clientId === selectedClientId) ? 'block' : 'none';
    });
    
    // Reset selections if they don't match the client
    if (prospectSelect.value) {
        const selectedProspectOption = prospectSelect.querySelector(`option[value="${prospectSelect.value}"]`);
        if (selectedProspectOption && selectedProspectOption.getAttribute('data-client') !== selectedClientId) {
            prospectSelect.value = '';
        }
    }
    
    if (contactSelect.value) {
        const selectedContactOption = contactSelect.querySelector(`option[value="${contactSelect.value}"]`);
        if (selectedContactOption && selectedContactOption.getAttribute('data-client') !== selectedClientId) {
            contactSelect.value = '';
        }
    }
}

// Handle URL parameters (e.g., from prospect edit page)
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const prospectId = urlParams.get('prospect_id');
    
    if (prospectId) {
        const prospectSelect = document.querySelector('select[name="prospect_id"]');
        prospectSelect.value = prospectId;
        
        // Auto-select the client based on the prospect
        const selectedOption = prospectSelect.querySelector(`option[value="${prospectId}"]`);
        if (selectedOption) {
            const clientId = selectedOption.getAttribute('data-client');
            document.querySelector('select[name="client_id"]').value = clientId;
            updateCustomerOptions();
        }
    }
});
</script>

{% endblock %}